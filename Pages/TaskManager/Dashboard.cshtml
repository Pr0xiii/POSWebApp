@page
@model PointOfSalesWebApplication.Pages.TaskManager.DashboardModel
@{
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-sm-12 dashboard-btns">
            <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                New Task
            </button>
            <h1 class="text-center mb-4">My Task Board</h1>
            <button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#createSectionModal">
                New Section
            </button>
        </div>
    </div>
    <div class="kanban-board">
        @if (Model.Sections != null)
        {
            @foreach (var sec in Model.Sections)
            {
                <div class="kanban-column bg-dark" data-section-id="@sec.ID">
                    <h4 class="text-light">@sec.Name</h4>
                    <div class="tasks"
                         data-section-id="@sec.ID"
                         style="min-height: 150px;">
                        @foreach (var task in sec.Tasks)
                        {
                            <div class="task-card" draggable="true" data-task-id="@task.ID">
                                <div class="task-priority priority-@task.PriorityLevel text-dark">@task.PriorityLevel</div>
                                <div class="text-dark">@task.Name</div>
                                <div class="task-card-footer">
                                    <small class="text-dark">@task.EndDate.ToString("yyyy-MM-dd")</small>
                                    <div class="task-actions">
                                        <button class="btn btn-outline-primary edit-task"
                                                data-bs-toggle="modal"
                                                data-bs-target="#createTaskModal"
                                                data-id="@task.ID"
                                                data-name="@task.Name"
                                                data-priority="@task.PriorityLevel"
                                                data-description="@task.Description"
                                                data-enddate="@task.EndDate.ToString("yyyy-MM-dd")">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <form method="post" asp-page-handler="RemoveTask">
                                            <input type="hidden" name="taskID" value="@task.ID" />
                                            <input type="hidden" name="taskName" value="@task.Name" />
                                            <button type="submit" class="btn btn-outline-danger task-card-btn">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- New Task Modal -->
<div class="modal fade" id="createTaskModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-light">
            <form method="post" asp-page-handler="SaveTask">
                <input type="hidden" asp-for="Task.ID" />

                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="createTaskModalLabel">
                        <span id="modalTitle">New Task</span>
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label asp-for="Task.Name"></label>
                        <input class="form-control" asp-for="Task.Name" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Task.PriorityLevel"></label>
                        <select class="form-control"
                                asp-for="Task.PriorityLevel"
                                asp-items="Model.Priorities"></select>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Task.EndDate"></label>
                        <input type="date" class="form-control" asp-for="Task.EndDate" />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Task.Description"></label>
                        <textarea class="form-control" asp-for="Task.Description"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>

        </div>
    </div>
</div>

<!-- New Section Modal -->
<div class="modal fade" id="createSectionModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="createSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <form method="post" asp-page-handler="CreateSection">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="createSectionModalLabel">New Section</h1>
                    <input type="reset" value="" class="btn btn-close btn-danger" data-bs-dismiss="modal" />
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" asp-for="@Model.Section.Name">Name:</label>
                        <input type="text" class="form-control" asp-for="@Model.Section.Name" />
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="reset" class="btn btn-danger" value="Reset" data-bs-dismiss="modal" />
                    <input type="submit" value="Add Section" class="btn btn-outline-success" id="liveToastBtn" />
                </div>
            </form>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3 text-bg-light">
    <div id="taskToast" class="toast text-bg-light" role="alert">
        <div class="toast-header">
            <strong class="me-auto text-dark"><i class="bi bi-info-circle-fill"></i> Task Manager</strong>
            <small class="text-dark">Now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body text-dark">
            @TempData["ToastMessage"]
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const shouldShowToast = '@TempData["TaskCreated"]';

        if (shouldShowToast === 'True') {
            const toastEl = document.getElementById('taskToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    });

    document.querySelectorAll('.edit-task').forEach(btn => {
        btn.addEventListener('click', function () {

            document.querySelector('#modalTitle').innerText = 'Edit Task';

            document.querySelector('[name="Task.ID"]').value = this.dataset.id;
            document.querySelector('[name="Task.Name"]').value = this.dataset.name;
            document.querySelector('[name="Task.PriorityLevel"]').value = this.dataset.priority;
            document.querySelector('[name="Task.Description"]').value = this.dataset.description;
            document.querySelector('[name="Task.EndDate"]').value = this.dataset.enddate;
        });
    });

    // Reset modal when creating
    document.querySelector('[data-bs-target="#createTaskModal"]').addEventListener('click', () => {
        document.querySelector('#modalTitle').innerText = 'New Task';
        document.querySelector('form').reset();
        document.querySelector('[name="Task.ID"]').value = 0;
    });
</script>

<script>
    let draggedTask = null;

    // === DRAG SOURCE ===
    document.querySelectorAll('.task-card').forEach(card => {
        card.addEventListener('dragstart', e => {
            draggedTask = card;

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', card.dataset.taskId);

            card.classList.add('dragging');
        });

        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
            draggedTask = null;
        });
    });

    // === DROP ZONES ===
    document.querySelectorAll('.tasks').forEach(column => {

        column.addEventListener('dragenter', e => {
            e.preventDefault(); // ⬅️ OBLIGATOIRE
            column.classList.add('drag-over');
        });

        column.addEventListener('dragover', e => {
            e.preventDefault(); // ⬅️ OBLIGATOIRE
        });

        column.addEventListener('dragleave', () => {
            column.classList.remove('drag-over');
        });

        column.addEventListener('drop', async e => {
            e.preventDefault();
            column.classList.remove('drag-over');

            const dropZone = e.target.closest('.tasks');
            if (!dropZone || !draggedTask) return;

            dropZone.appendChild(draggedTask);

            const taskId = draggedTask.dataset.taskId;
            const sectionId = dropZone.dataset.sectionId;
            const order = [...dropZone.children].indexOf(draggedTask);

            await updateTaskPosition(taskId, sectionId, order);
        });
    });

    async function updateTaskPosition(taskId, sectionId, order) {
        await fetch('?handler=MoveTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken':
                    document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify({ taskId, sectionId, order })
        });
    }
</script>
